#! /bin/bash

set -e

# Install node dependencies
npm ci --install-links --no-audit

#OS_ARCH=$(uname -m)
NO_CACHE_FLAG=''

# Workaround when building in a Mac
# if [ $OS_ARCH != "x86_64" ]; then
#   NO_CACHE_FLAG='--no-cache'
# fi

BUILDKIT=''
if [[ -n "$DOCKER_BUILDKIT" ]]; then 
  BUILDKIT=buildx
fi

BUILDKIT_CACHING=()
if [[ -n "$GITHUB_ACTIONS" ]]; then 
  export ACTIONS_CACHE_URL=$(echo "$ACTIONS_ID_TOKEN_REQUEST_URL" | grep -Po 'https://[^/]+/[^/]+/' | sed  's/pipelines/artifactcache/')
  export ACTIONS_RUNTIME_TOKEN=$ACTIONS_ID_TOKEN_REQUEST_TOKEN
  BUILDKIT_CACHING=(--load --cache-to "type=gha,mode=max" --cache-from type=gha)
  docker buildx create --use --bootstrap --driver=docker-container
fi

#docker $BUILDKIT build $NO_CACHE_FLAG  "${BUILDKIT_CACHING[@]}" -t ghcr.io/fullkomnun/local-circom - < docker/circom.Dockerfile

# containers built separately. A parallel build fails.

if [[ -z "${NF_SERVICES_TO_START}" || "${NF_SERVICES_TO_START}" == *"administrator"* ]]; then
  docker $BUILDKIT build $NO_CACHE_FLAG "${BUILDKIT_CACHING[@]}" -t ghcr.io/fullkomnun/nightfall3-administrator -f docker/admin.Dockerfile .
fi

if [[ -z "${NF_SERVICES_TO_START}" || "${NF_SERVICES_TO_START}" == *"client"* || "${NF_SERVICES_TO_START}" == *"adversary"* ]]; then
  docker $BUILDKIT build $NO_CACHE_FLAG "${BUILDKIT_CACHING[@]}" -t ghcr.io/fullkomnun/nightfall3-client -f docker/client.Dockerfile .
fi

if [[ -z "${NF_SERVICES_TO_START}" || "${NF_SERVICES_TO_START}" == *"deployer"* ]]; then
  docker $BUILDKIT build $NO_CACHE_FLAG "${BUILDKIT_CACHING[@]}" -t ghcr.io/fullkomnun/nightfall3-deployer -f docker/deployer.Dockerfile .
fi

if [[ -z "${NF_SERVICES_TO_START}" || "${NF_SERVICES_TO_START}" == *"hosted-utils-api-server"* ]]; then
  docker $BUILDKIT build $NO_CACHE_FLAG "${BUILDKIT_CACHING[@]}" -t ghcr.io/fullkomnun/nightfall3-hosted-utils-api-server -f docker/hosted-utils-api-server.Dockerfile ./hosted-utils-api-server
fi

if [[ -z "${NF_SERVICES_TO_START}" || "${NF_SERVICES_TO_START}" == *"optimist"* || "${NF_SERVICES_TO_START}" == *"adversary"* ]]; then
  docker $BUILDKIT build $NO_CACHE_FLAG "${BUILDKIT_CACHING[@]}" -t ghcr.io/fullkomnun/nightfall3-optimist -f docker/optimist.Dockerfile .
fi

if [[ -z "${NF_SERVICES_TO_START}" || "${NF_SERVICES_TO_START}" == *"proposer"* ]]; then
  docker $BUILDKIT build $NO_CACHE_FLAG "${BUILDKIT_CACHING[@]}" -t ghcr.io/fullkomnun/nightfall3-proposer -f docker/proposer.Dockerfile .
fi

if [[ -z "${NF_SERVICES_TO_START}" || "${NF_SERVICES_TO_START}" == *"challenger"* ]]; then
  docker $BUILDKIT build $NO_CACHE_FLAG "${BUILDKIT_CACHING[@]}" -t ghcr.io/fullkomnun/nightfall3-challenger -f docker/challenger.Dockerfile .
fi

if [[ -z "${NF_SERVICES_TO_START}" || "${NF_SERVICES_TO_START}" == *"worker"* ]]; then
  docker $BUILDKIT build $NO_CACHE_FLAG "${BUILDKIT_CACHING[@]}" -t ghcr.io/fullkomnun/nightfall3-worker -f docker/worker.Dockerfile .
fi
